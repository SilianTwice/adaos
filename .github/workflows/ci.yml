# infra-inimatic/.github/workflows/deploy.yml
name: Deploy on images published
on:
  repository_dispatch:
    types: [images-published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script_stop: true
          script: |
            set -euo pipefail
            BACKEND="${{ github.event.client_payload.backend }}"
            FRONTEND="${{ github.event.client_payload.frontend }}"
            echo "Deploying: $BACKEND / $FRONTEND"

            # пробрасываем теги в окружение деплой-скрипта
            export BACKEND_IMAGE="$BACKEND"
            export FRONTEND_IMAGE="$FRONTEND"

            cd /opt/inimatic/docker/compose
            docker login ghcr.io -u ${{ secrets.GHCR_USER }} -p ${{ secrets.GHCR_TOKEN }} || true
            docker pull "$BACKEND" || true
            docker pull "$FRONTEND" || true

            # твой существующий деплой-скрипт, который читает переменные
            ENVF="/opt/inimatic/.env" bash /opt/inimatic/scripts/your_deploy.sh
